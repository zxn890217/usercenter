<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.usercenter.sys.dao.UserGroupDao">
    <resultMap type="com.example.usercenter.sys.entity.UserGroup" id="UserGroupMap">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="path" column="path"/>
        <association property="parent" javaType="com.example.usercenter.sys.entity.UserGroup">
            <id property="id" column="pid"/>
            <result property="name" column="pname"/>
        </association>
    </resultMap>

    <sql id="select-fields">
    id,name,pid,path
    </sql>

    <select id="get" parameterType="Long" resultMap="UserGroupMap">
        SELECT * FROM user_group
        WHERE id = #{id}
    </select>

    <insert id="insert" parameterType="com.example.usercenter.sys.entity.UserGroup" >
        INSERT INTO user_group(name,pid,path, pid)
        VALUES(#{name},#{pid},#{path},
        <choose>
            <when test="parent != null and parent.id != null">#{parent.id}</when>
            <otherwise>0</otherwise>
        </choose>)
    </insert>

    <update id="update" parameterType="com.example.usercenter.sys.entity.UserGroup">
        UPDATE user_group
        <set>
            name = #{name},
            pid = #{pid},
            path = #{path},
            <choose>
                <when test="parent != null">pid = #{parent.id}</when>
                <otherwise>pid = 0</otherwise>
            </choose>
        </set>
        WHERE id = #{id}
    </update>

    <update id="updateChildrenPathById">
        UPDATE user_group SET path = CONCAT(#{newPath}, SUBSTRING(path, LENGTH(#{oldPath})+1)) WHERE parent_id = #{id}
    </update>

    <update id="updateChildrenPathByPath">
        UPDATE user_group SET path = CONCAT(#{newPath}, SUBSTRING(path, LENGTH(#{oldPath})+1)) where path like CONCAT(#{oldPath},#{id},'/%')
    </update>

    <update id="updateChildrenToRoot" parameterType="com.example.usercenter.sys.entity.UserGroup">
        UPDATE user_group SET pid = 0, path = SUBSTRING(path, LENGTH(CONCAT(#{path},#{id},'/'))) where path like CONCAT(#{path},#{id},'/%')
    </update>

    <update id="sensitiveUpdate" parameterType="com.example.usercenter.sys.entity.UserGroup">
        UPDATE user_group
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="pid != null">pid = #{pid},</if>
            <if test="path != null">path = #{path},</if>
            <if test="parent != null">parent_id = #{parent.id},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM user_group
        WHERE id = #{id}
    </delete>

    <select id="exists" parameterType="com.example.usercenter.sys.entity.UserGroup" resultType="int">
        select count(*) from user_group
        <where>
            <if test="id != null">id = #{id},</if>
            <if test="name != null">name = #{name},</if>
            <if test="pid != null">pid = #{pid},</if>
            <if test="path != null">path = #{path},</if>
        </where>
    </select>

    <sql id="select-conditions">
        <if test="id != null">AND id = #{id}</if>
        <if test="name != null">AND name = #{name}</if>
        <if test="pid != null">AND pid = #{pid}</if>
        <if test="path != null">AND path = #{path}</if>
    </sql>

    <select id="count" parameterType="java.util.Map" resultType="int">
        SELECT count(*) FROM user_group
        <where>
            <include refid="select-conditions"/>
        </where>
    </select>

    <select id="query" parameterType="java.util.Map" resultMap="UserGroupMap">
        SELECT <include refid="select-fields"/> FROM user_group
        <where>
            <include refid="select-conditions"/>
        </where>
        <if test="sort != null">
            order by ${sort} ${order}
        </if>
        <if test="limit > 0">
            limit #{offset},#{limit}
        </if>
    </select>
</mapper>